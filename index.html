<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Free-form Selection and Copy Text</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #pdf-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: auto;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed #FF0000;
            background-color: rgba(255, 0, 0, 0.2);
            pointer-events: none;
            z-index: 9999;
            display: none;
        }

        #pdfCanvas {
            display: block;
            margin: 0 auto;
        }

        #copyButton {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        #copyButton:hover {
            background: #218838;
        }

    </style>
</head>
<body>
    <div id="pdf-container">
        <canvas id="pdfCanvas"></canvas>
        <div id="textLayer" class="textLayer"></div>
    </div>

    <button id="copyButton">Copy Selected Text</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>

    <script>
        const pdfUrl = 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'; // Replace with your PDF URL
        const canvas = document.getElementById('pdfCanvas');
        const context = canvas.getContext('2d');
        const textLayer = document.getElementById('textLayer');
        const copyButton = document.getElementById('copyButton');
        let pdfDoc = null;
        let currentPage = 1;
        let selectionPolygon = []; // Array to store points for free-form selection
        let selectionBox = null;

        // Load the PDF
        pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
            pdfDoc = pdf;
            renderPage(currentPage);
        });

        // Render the PDF page
        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext).promise.then(() => {
                    renderTextLayer(page, viewport);
                });
            });
        }

        // Render text layer
        function renderTextLayer(page, viewport) {
            page.getTextContent().then(textContent => {
                const div = document.createElement('div');
                div.classList.add('textLayer');
                textLayer.appendChild(div);

                pdfjsLib.renderTextLayer({
                    textContent,
                    container: div,
                    viewport,
                    textDivs: []
                });
            });
        }

        // Handle mouse down event to start free-form selection
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const startX = e.clientX - rect.left;
            const startY = e.clientY - rect.top;

            selectionPolygon = [{ x: startX, y: startY }];
            if (selectionBox) {
                selectionBox.style.display = 'none';
            }

            // Create a new selection box for visual feedback
            selectionBox = document.createElement('div');
            selectionBox.classList.add('selection-box');
            selectionBox.style.left = `${startX}px`;
            selectionBox.style.top = `${startY}px`;
            document.body.appendChild(selectionBox);

            // Track mouse movement to update the selection box
            const mouseMoveHandler = (moveEvent) => {
                const width = moveEvent.clientX - rect.left - startX;
                const height = moveEvent.clientY - rect.top - startY;

                selectionPolygon.push({ x: moveEvent.clientX - rect.left, y: moveEvent.clientY - rect.top });

                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `${Math.abs(height)}px`;
                if (width < 0) selectionBox.style.left = `${moveEvent.clientX - rect.left}px`;
                if (height < 0) selectionBox.style.top = `${moveEvent.clientY - rect.top}px`;
            };

            // Stop tracking mouse movement on mouse up
            const mouseUpHandler = () => {
                canvas.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                selectionBox.style.display = 'none'; // Hide the selection box after release
                getTextInsidePolygon();
            };

            canvas.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
        });

        // Get text inside the selected polygon
        function getTextInsidePolygon() {
            if (selectionPolygon.length < 3) return;

            const selectedArea = new Path2D();
            selectionPolygon.forEach(point => selectedArea.lineTo(point.x, point.y));
            selectedArea.closePath();

            const page = pdfDoc.getPage(currentPage);
            page.then((page) => {
                const viewport = page.getViewport({ scale: 1.5 });
                page.getTextContent().then((textContent) => {
                    const textItems = textContent.items;
                    let selectedText = '';

                    textItems.forEach(item => {
                        const x = item.transform[4];
                        const y = item.transform[5];
                        const width = item.width;
                        const height = item.height;

                        // Check if the text item's coordinates are inside the polygon
                        if (isPointInsidePolygon(x, y, selectedArea)) {
                            selectedText += item.str + ' ';
                        }
                    });

                    if (selectedText) {
                        navigator.clipboard.writeText(selectedText.trim()).then(() => {
                            alert('Text copied to clipboard!');
                        }).catch((err) => {
                            console.error('Error copying text: ', err);
                        });
                    }
                });
            });
        }

        // Function to check if a point is inside a polygon
        function isPointInsidePolygon(x, y, polygon) {
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.beginPath();
            polygon.forEach(point => ctx.lineTo(point.x, point.y));
            ctx.closePath();
            return ctx.isPointInPath(x, y);
        }

        // Button click event to copy selected text
        copyButton.addEventListener('click', () => {
            getTextInsidePolygon();
        });
    </script>
</body>
</html>
